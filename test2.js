var haveimage = ['K.png', 'KAbukuma.jpg', 'KAbukumaKai.jpg', 'KAganoKai.jpg', 'KAkagi.png', 'KAkagiKai.png', 'KAkashi.jpg', 'KAkashiKai.jpg', 'KAkatsuki.jpg', 'KAkatsukiKai.png', 'KAkatsukiKai2.jpg', 'KAkebono.jpg', 'KAkebonoKai.png', 'KAkigumo.jpg', 'KAkitsuMaru.jpg', 'KAkitsuMaruKai.jpg', 'KAkitsushima.jpg', 'KAkitsushimaKai.jpg', 'KAkizukiKai.jpg', 'KAmagiKai.jpg', 'KAmatsukaze.jpg', 'KAmatsukazeKai.jpg', 'KAoba.jpg', 'KAobaKai.png', 'KArare.png', 'KArashio.jpg', 'KAsagumoKai.jpg', 'KAsashimoKai.jpg', 'KAsashio.jpg', 'KAshigara.jpg', 'KAshigaraKai.png', 'KAshigaraKai2.jpg', 'KAtago.jpg', 'KAtagoKai.png', 'KAyanami.jpg', 'KAyanamiKai.png', 'KAyanamiKai2.jpg', 'KBismarck.jpg', 'KBismarckdrei.jpg', 'KBismarckKai.jpg', 'KChi.jpg', 'KChiE.png', 'KChiF.png', 'KChikuma.jpg', 'KChikumaKai2.jpg', 'KChitose.jpg', 'KChitoseA.jpg', 'KChitoseCVLKai2.jpg', 'KChiyoda.jpg', 'KChiyodaA.jpg', 'KChiyodaCVLKai2.jpg', 'KChoukai.jpg', 'KChoukaiKai.png', 'KChoukaiKai2.jpg', 'KFubuki.jpg', 'KFubukiKai.png', 'KFubukiKai2.jpg', 'KFumizuki.png', 'KFumizukiKai.png', 'KFurutaka.jpg', 'KFurutakaKai2.jpg', 'KFusou.jpg', 'KFusouKai.jpg', 'KFusouKai2.jpg', 'KHa.jpg', 'KHaE.png', 'KHaguro.png', 'KHaguroKai.png', 'KHaguroKai2.jpg', 'KHamakaze.jpg', 'KHaruna.jpg', 'KHarunaKai.png', 'KHarunaKai2.jpg', 'KHarusameKai.jpg', 'KHatsuharu.jpg', 'KHatsuharuKai.png', 'KHatsushimo.png', 'KHatsushimoKai.png', 'KHatsushimoKai2.jpg', 'KHatsuyuki.jpg', 'KHatsuyukiKai.png', 'KHe.jpg', 'KHeE.jpg', 'KHeF.jpg', 'KHibiki.png', 'KHibikiKai.png', 'KHiei.jpg', 'KHieiKai.png', 'KHieiKai2.jpg', 'KHiryuu.png', 'KHiryuuKai.jpg', 'KHiryuuKai2.jpg', 'KHiyou.jpg', 'KHiyouKai.jpg', 'KHo.jpg', 'KHoE.jpg', 'KHoF.jpg', 'KHoushou.jpg', 'KHoushouKai.png', 'KHyuuga.jpg', 'KHyuugaKai.jpg', 'KI-168.jpg', 'KI-168Kai.jpg', 'KI-19.jpg', 'KI-19Kai.jpg', 'KI-401.jpg', 'KI-401Kai.jpg', 'KI-58.jpg', 'KI-58Kai.jpg', 'KI-8.jpg', 'KI-8Kai.jpg', 'KI.jpg', 'KIE.png', 'KIkazuchi.jpg', 'KIkazuchiKai.png', 'KInazuma.png', 'KInazumaKai.png', 'KIse.jpg', 'KIseKai.jpg', 'KIsonami.png', 'KIsonamiKai.png', 'KIsuzu.jpg', 'KIsuzuKai.jpg', 'KIsuzuKai2.jpg', 'KItalia.jpg', 'KJintsuu.jpg', 'KJintsuuKai.jpg', 'KJintsuuKai2.jpg', 'KJunyou.png', 'KJunyouKai.jpg', 'KJunyouKai2.jpg', 'KKa.jpg', 'KKaE.jpg', 'KKaga.jpg', 'KKagaKai.png', 'KKako.jpg', 'KKakoKai.png', 'KKakoKai2.jpg', 'KKasumi.jpg', 'KKatoriKai.jpg', 'KKatsuragi.jpg', 'KKatsuragiKai.jpg', 'KKikuzuki.png', 'KKikuzukiKai.png', 'KKinu.jpg', 'KKinugasa.jpg', 'KKinugasaKai.jpg', 'KKinugasaKai2.jpg', 'KKinuKai.jpg', 'KKirishima.jpg', 'KKirishimaKai.png', 'KKirishimaKai2.jpg', 'KKisaragi.png', 'KKisaragiKai.png', 'KKiso.png', 'KKisoKai.jpg', 'KKisoKai2.jpg', 'KKitakami.jpg', 'KKitakamiKai.png', 'KKitakamiKai2.jpg', 'KKiyoshimo.jpg', 'KKiyoshimoKai.jpg', 'KKongou.png', 'KKongouKai.png', 'KKongouKai2.jpg', 'KKuma.jpg', 'KKumaKai.jpg', 'KKumano.jpg', 'KKumanoKai.jpg', 'KKuroshio.jpg', 'KKuroshioKai.jpg', 'KLittorio.jpg', 'KMaikazeKai.jpg', 'KMakigumo.jpg', 'KMaruyu.jpg', 'KMaruyuKai.jpg', 'KMaya.jpg', 'KMayaKai.png', 'KMayaKai2.jpg', 'KMichishio.jpg', 'KMikazuki.png', 'KMikazukiKai.png', 'KMikuma.jpg', 'KMikumaKai.jpg', 'KMiyuki.jpg', 'KMochizuki.png', 'KMochizukiKai.png', 'KMogami.jpg', 'KMogamiKai.png', 'KMurakumo.jpg', 'KMurakumoKai.png', 'KMurakumoKai2.jpg', 'KMurasame.jpg', 'KMurasameKai.jpg', 'KMusashiKai.jpg', 'KMutsu.png', 'KMutsuKai.png', 'KMutsuki.png', 'KMutsukiKai.png', 'KMyoukou.jpg', 'KMyoukouKai.png', 'KMyoukouKai2.jpg', 'KNachi.jpg', 'KNachiKai.png', 'KNachiKai2.jpg', 'KNaganami.jpg', 'KNagara.png', 'KNagaraKai.jpg', 'KNagato.png', 'KNagatoKai.png', 'KNagatsuki.png', 'KNagatsukiKai.png', 'KNaka.png', 'KNakaKai2.jpg', 'KNatori.png', 'KNatoriKai.jpg', 'KNenohi.png', 'KNi.jpg', 'KNiE.png', 'KNoshiro.jpg', 'KNoshiroKai.jpg', 'KNowaki.jpg', 'KNu.jpg', 'KNuE.jpg', 'KOboro.jpg', 'KOoiKai.png', 'KOoiKai2.jpg', 'KOoshio.jpg', 'KOoshioKai.png', 'KOoyodoKai.jpg', 'KPrinzEugenKai.jpg', 'KRi.png', 'KRiE.png', 'KRiF.png', 'KRo-500.jpg', 'KRo.jpg', 'KRoE.png', 'KRoF.jpg', 'KRoma.jpg', 'KRomaKai.jpg', 'KRu.png', 'KRuE.png', 'KRuF.png', 'KRyuujou.jpg', 'KRyuujouKai.jpg', 'KSakawa.jpg', 'KSakawaKai.jpg', 'KSamidare.jpg', 'KSatsuki.jpg', 'KSatsukiKai.png', 'KSazanami.jpg', 'KSazanamiKai.png', 'KSendai.png', 'KSendaiKai2.jpg', 'KShigure.jpg', 'KShigureKai2.jpg', 'KShikinami.jpg', 'KShimakaze.png', 'KShimakazeKai.png', 'KShiranui.jpg', 'KShiranuiKai.jpg', 'KShiratsuyu.jpg', 'KShirayuki.png', 'KShouhou.jpg', 'KShouhouKai.png', 'KShoukaku.jpg', 'KShoukakuKai.jpg', 'KSouryuu.jpg', 'KSouryuuKai.png', 'KSouryuuKai2.jpg', 'KSuzukaze.jpg', 'KSuzuya.jpg', 'KSuzuyaKai.jpg', 'KTaE.jpg', 'KTaF.jpg', 'KTaigei.jpg', 'KTaihouKai.jpg', 'KTakanami.jpg', 'KTakanamiKai.jpg', 'KTakao.jpg', 'KTakaoKai.png', 'KTama.jpg', 'KTamaKai.jpg', 'KTatsuta.jpg', 'KTenryuu.jpg', 'KTenryuuKai.jpg', 'KTo.jpg', 'KToE.jpg', 'KTokitsukazeKai.jpg', 'KTone.jpg', 'KToneKai.png', 'KToneKai2.jpg', 'KU-511Kai.jpg', 'KUnryuu.jpg', 'KUnryuuKai.jpg', 'KUshio.jpg', 'KUshioKai.png', 'KUshioKai2.jpg', 'KUzuki.jpg', 'KUzukiKai.jpg', 'KVerniy.jpg', 'KWa.jpg', 'KWaE.png', 'KWakaba.jpg', 'KWakabaKai.png', 'KWo.png', 'KWoE.png', 'KYahagi.jpg', 'KYamashiro.jpg', 'KYamashiroKai.jpg', 'KYamashiroKai2.jpg', 'KYamato.jpg', 'KYamatoKai.jpg', 'KYayoi.jpg', 'KYayoiKai.jpg', 'KYo.jpg', 'KYoE.jpg', 'KYukikaze.png', 'KYukikazeKai.png', 'KYura.jpg', 'KYuraKai.jpg', 'KYuubari.jpg', 'KYuubariKai.jpg', 'KYuudachi.jpg', 'KYuudachiKai.png', 'KYuudachiKai2.jpg', 'KYuugumoKai.jpg', 'KZ1.jpg', 'KZ3.jpg', 'KZuihou.jpg', 'KZuihouKai.jpg', 'KZuikaku.jpg', 'KZuikakuKai.jpg', 'KWoF.jpg', 'KHaF.png', 'KKaF.png', 'KBBH.jpg','KHarbourH2.jpg'];

var code = '';//'1,1,1~Nenohi,30|HatsushimoKai2,31|WakabaKai,30|HatsuharuKai,30|KagaKai,79|AkagiKai,77~RuF,98|RuE,90|HoF,53|ChiE,50|NiE,45|NiE,45~A:4,12,0|4,14,0|4,11,12|5,10,24|5,15,136|5,14,0|5,14,0~T:~S:2,13,1,0|10,4,1,0|1,12,1,21|11,3,1,0|0,12,1,0|13,2,1,0|3,13,1,30|12,3,1,15|4,12,4,110|14,4,1,0|5,14,4,0~S:0,10,1,10|10,2,1,0|1,14,1,75|11,5,1,0|2,10,1,5|13,3,1,8|3,11,1,8|4,11,4,85|5,10,4,0~T:0,10,5|1,10,10|2,10,4~N:0,10,2,4,2|10,4,2,47,2|1,13,2,131,119|2,10,2,85,84~'

var SHIPIDSORTED = [0,80,275,81,276,77,82,87,88,20,228,83,277,84,278,90,279,197,91,280,196,50,229,9,201,426,10,202,32,203,11,204,33,205,420,12,206,13,207,195,14,208,24,57,118,25,58,119,78,209,149,86,210,150,79,211,151,85,212,152,89,285,26,286,411,27,287,412,51,213,52,214,76,281,157,1,254,434,2,255,435,28,256,29,257,6,258,30,259,7,260,31,261,99,215,100,216,101,217,146,21,218,22,219,141,53,221,23,220,54,222,158,55,223,159,56,224,160,102,104,103,105,70,73,59,262,416,60,263,417,61,264,62,265,319,63,266,192,64,267,193,65,268,194,66,269,67,270,68,271,428,69,272,427,71,273,188,72,274,189,75,283,92,284,408,93,230,15,231,94,232,16,233,407,34,234,437,35,235,147,36,236,37,237,38,238,326,39,239,40,240,41,241,419,42,242,43,243,145,44,244,45,245,144,46,246,47,247,95,248,96,249,97,250,98,251,48,252,49,253,17,225,18,226,19,227,74,282,106,107,108,291,296,109,292,297,110,288,461,466,111,112,462,467,113,289,114,290,200,115,293,116,117,120,121,190,300,122,294,123,295,142,191,401,124,129,125,130,126,398,127,399,128,400,131,136,132,301,133,302,134,303,135,304,137,305,138,306,139,307,140,314,143,148,153,156,154,343,155,403,161,166,163,402,164,308,165,309,167,320,168,317,169,313,170,312,171,172,173,178,174,310,179,175,311,180,176,177,181,316,182,187,183,321,184,185,318,186,322,404,406,331,429,332,430,405,323,409,324,410,325,413,327,414,328,415,329,421,330,422,346,424,345,425,344,431,334,436,441,446,442,447,443,347,445,450,451,348,453,349,458,350,459,351,460,352];
var SHIPCLASSSORTED = {'Battleships':[],'Carriers':[],'Light Carriers':[],'Heavy Cruisers':[],'Light Cruisers':[],'Destroyers':[],'Submarines':[],'Auxiliary':[]};
for (var i=0; i<SHIPIDSORTED.length; i++) {
	if (SHIPIDSORTED[i] < 500) {
		switch(SHIPDATA[SHIPIDSORTED[i]].type) {
			case 'BB':
			case 'BBV':
			case 'BBVT':
				SHIPCLASSSORTED['Battleships'].push(SHIPIDSORTED[i]);
				break;
			case 'CV':
			case 'CVN':
			case 'CVB':
				SHIPCLASSSORTED['Carriers'].push(SHIPIDSORTED[i]);
				break;
			case 'CVL':
				SHIPCLASSSORTED['Light Carriers'].push(SHIPIDSORTED[i]);
				break
			case 'CA':
			case 'CAV':
				SHIPCLASSSORTED['Heavy Cruisers'].push(SHIPIDSORTED[i]);
				break;
			case 'CL':
			case 'CLT':
			case 'CT':
				SHIPCLASSSORTED['Light Cruisers'].push(SHIPIDSORTED[i]);
				break;
			case 'DD':
				SHIPCLASSSORTED['Destroyers'].push(SHIPIDSORTED[i]);
				break;
			case 'SS':
			case 'SSV':
				SHIPCLASSSORTED['Submarines'].push(SHIPIDSORTED[i]);
				break;
			default:
				SHIPCLASSSORTED['Auxiliary'].push(SHIPIDSORTED[i]);
				break;
		}
	}
}
// console.log(SHIPCLASSSORTED);





function shuffle(o) {
	for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
	return o;
}

function loadFile(fleet,hide) {
	var files = document.getElementById('T'+fleet+'sfile').files;
	var reader = new FileReader();
	reader.readAsText(files[0]);
	reader.addEventListener('loadend',function() { processFile(fleet,reader); });
	// document.getElementById('fleetchoose'+hide).style.display = 'none';
}

function processFile(fleetnum,reader) {
	// if (started) return;
	var kcdata = JSON.parse(reader.result);
	// console.log(kcdata);

	// genFleetHTML('fleetspace'+fleet);
	
	var fleet = kcdata.fleets[0].ships;
	// var s1 = [];
	for (var i=0; i<fleet.length; i++) {
		var fid = fleet[i];
		if (fid <= 0) { clickedClear(fleetnum,i); continue; }
		var mid = kcdata.ships['x'+fid].masterId;
		var ship = kcdata.ships['x'+fid];
		var name = SHIPDATA[mid].name;
		if (!name) name = '';
		// console.log(fid+' '+mid+' '+name);
		// var ShipType = SHIPDATA[mid].type;
		// s1.push(new ShipType(mid,name,0,ship.level,ship.hp[1],ship.fp[0],ship.tp[0],ship.aa[0],ship.ar[0],ship.ev[0],ship.as[0],ship.ls[0],ship.lk[0],ship.range,ship.slots.splice(0,4)));
		
		var equips = [];
		for (var j=0; j<4; j++) {  //get equip mids
			console.log(ship.items[j]);
			if (ship.items[j] == -1) equips.push(0);
			else equips.push(kcdata.gears['x'+ship.items[j]].masterId);
		}
		//REMEMBER HARDCODED TABLE 1, AND SPEED 1
		tableSetShip(fleetnum,i,mid,[ship.level,ship.hp[1],ship.fp[0],ship.tp[0],ship.aa[0],ship.ar[0],ship.ev[0],ship.as[0],ship.ls[0],ship.lk[0],ship.range,SHIPDATA[mid].SPD],equips);  
	}
	updateFleetCode(fleetnum);
	
	// var f1 = new Fleet(0);
	// f1.loadShips(s1);
	// f1.formation = LINEAHEAD;
	
	
	// for (var i=0; i<fleet.length; i++) {
		//WHAT DID I TYPE THIS FOR????
	// }
	// sim(f1,FLEET2);
	// setup();
	// started = true;
}

function hidePlayer() {
	var p = document.getElementById('movie');
	if (p.style.display == 'none') p.style.display = 'block';
	else p.style.display = 'none';
}

function genResultsHTML(data) {
	var root = $('#resultspace');
	
	if (!WROTESTATS) {
		if (data.nodes.length <= 1) { //single node display
			$('#resulttempsingle').show();
		
		} else {  //multi node display
			// $('#resulttempsingle').hide();
			var battle = data.nodes[0];
			// var multitemp = ($('<div id="resulttempmulti"></div>'));
			// root.append(multitemp);
			// multitemp.append($('<div>Number of runs: <span id="rnumruns">'+data.totalnum+'</span></div><br>'));
			
			// var rankdiv = $('<div style="float:left;width:250px"></div>')
			// multitemp.append(rankdiv);
			// rankdiv.append($('<span>Final Rank Rate:</span><br>'));
			// rankdiv.append($('<img src="_assets/stats/S.png"></img> <span id="rankS" style="font-weight:bold">0</span><br>'));
			// rankdiv.append($('<img src="_assets/stats/A.png"></img> <span id="rankA">0</span><br>'));
			// rankdiv.append($('<img src="_assets/stats/B.png"></img> <span id="rankB">0</span><br>'));
			// rankdiv.append($('<img src="_assets/stats/C.png"></img> <span id="rankC">0</span><br>'));
			// rankdiv.append($('<img src="_assets/stats/D.png"></img> <span id="rankD">0</span><br>'));
			// rankdiv.append($('<img src="_assets/stats/salt.png"></img> <span id="rankNone">0</span><br>'));
			// rankdiv.append($('<br>'));
			// rankdiv.append($('<span>Enemy Flagship Sunk Rate:</span><br>'));
			// rankdiv.append($('<img src="_assets/stats/flagsunk.png"></img> <span id="rsunkfs" style="font-weight:bold">0</span><br>'));
			// rankdiv.append($('<br>'));
			// var ranktab = $('<table></table>');
			// rankdiv.append(ranktab);
			// ranktab.append($('<tr><th></th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr>'));
			// ranktab.append($('<tr><th><img src="_assets/stats/S.png"/></th><td>0.222</td><td>0.222</td><td>0.222</td><td>0.222</td><td>0.222</td></tr>'));
			// ranktab.append($('<tr><th><img src="_assets/stats/A.png"/></th><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>'));
			// ranktab.append($('<tr><th><img src="_assets/stats/B.png"/></th><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>'));
			// ranktab.append($('<tr><th><img src="_assets/stats/C.png"/></th><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>'));
			// ranktab.append($('<tr><th><img src="_assets/stats/D.png"/></th><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>'));
			// ranktab.append($('<tr><th><img src="_assets/stats/flagsunk.png"/></th><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>'));
			
			// var mvpdiv = $('<div style="float:left;width:250px">');
			// multitemp.append(mvpdiv);
			// mvpdiv.append($('<span>MVP Rate:</span><br>'));
			// mvpdiv.append($('<img src="_assets/stats/F1.png"></img> <span id="mvp1">0</span><br>'));
			// mvpdiv.append($('<img src="_assets/stats/F2.png"></img> <span id="mvp2">0</span><br>'));
			// mvpdiv.append($('<img src="_assets/stats/F3.png"></img> <span id="mvp3">0</span><br>'));
			// mvpdiv.append($('<img src="_assets/stats/F4.png"></img> <span id="mvp4">0</span><br>'));
			// mvpdiv.append($('<img src="_assets/stats/F5.png"></img> <span id="mvp5">0</span><br>'));
			// mvpdiv.append($('<img src="_assets/stats/F6.png"></img> <span id="mvp6">0</span><br>'));
			
			// var dmgdiv = $('<div style="float:left;width:250px">');
			// multitemp.append(dmgdiv);
			// dmgdiv.append($('<span>Major Damage Rate:</span><br>'));
			// dmgdiv.append($('<img src="_assets/stats/taiha.png"></img>Any: <span id="rredany" style="font-weight:bold">0</span><br>'));
			// dmgdiv.append($('<br>'));
			// dmgdiv.append($('<span>Individual:</span><br>'));
			// dmgdiv.append($('<img src="_assets/stats/F1.png"></img> <span id="red1">0</span><br>'));
			// dmgdiv.append($('<img src="_assets/stats/F2.png"></img> <span id="red2">0</span><br>'));
			// dmgdiv.append($('<img src="_assets/stats/F3.png"></img> <span id="red3">0</span><br>'));
			// dmgdiv.append($('<img src="_assets/stats/F4.png"></img> <span id="red4">0</span><br>'));
			// dmgdiv.append($('<img src="_assets/stats/F5.png"></img> <span id="red5">0</span><br>'));
			// dmgdiv.append($('<img src="_assets/stats/F6.png"></img> <span id="red6">0</span><br>'));
			// dmgdiv.append($('<br>'));
			// dmgdiv.append($('<span>No Medium Damage:</span><br>'));
			// dmgdiv.append($('<img src=""></img> <span id="rnodam">0</span><br>'));
			// dmgdiv.append($('<br>'));
			
			// var resdiv = $('<div style="float:left;width:250px">');
			// multitemp.append(resdiv);
			// resdiv.append($('<span>Avg Resupply:</span><br>'));
			// resdiv.append($('<img src="_assets/stats/fuel.png"></img> <span id="rfsup">0</span><br>'));
			// resdiv.append($('<img src="_assets/stats/ammo.png"></img> <span id="rasup">0</span><br>'));
			// resdiv.append($('<img src="_assets/stats/baux.png"></img> <span id="rbsup">0</span><br><br>'));
			// resdiv.append($('<span>Avg Repair:</span><br>'));
			// resdiv.append($('<img src="_assets/stats/fuel.png"></img> <span id="rfrep">0</span><br>'));
			// resdiv.append($('<img src="_assets/stats/steel.png"></img> <span id="rsrep">0</span><br><br>'));
			// resdiv.append($('<span>Avg Total Resource:</span><br>'));
			// resdiv.append($('<img src="_assets/stats/fuel.png"></img> <span id="rftot" style="font-weight:bold">0</span><br>'));
			// resdiv.append($('<img src="_assets/stats/ammo.png"></img> <span id="ratot" style="font-weight:bold">0</span><br>'));
			// resdiv.append($('<img src="_assets/stats/steel.png"></img> <span id="rstot" style="font-weight:bold">0</span><br>'));
			// resdiv.append($('<img src="_assets/stats/baux.png"></img> <span id="rbtot" style="font-weight:bold">0</span><br>'));
			// resdiv.append($('<br>'));
		}
	}
	
	WROTESTATS = true;
}

//deprecated
function setup() {
	if (!ALLLOADED) {
		setTimeout(function() { setup(); },200);
		console.log('a');
		return;
	}
	console.log(code);
	
	var phases = code.split('~');

	var ships1 = phases[1].split('|');
	for (i=0; i<ships1.length; i++) {
		fleet1.push(createShip(ships1[i].split(','),0,i));
		stage.addChild(fleet1[i].graphic);
	}

	var ships2 = phases[2].split('|');
	for (i=0; i<ships2.length; i++) {
		fleet2.push(createShip(ships2[i].split(','),1,i));
		stage.addChild(fleet2[i].graphic);
	}
	
	var s = phases[0].split(',');
	GEngage = s[0].replace('B:',''); GAP1 = s[3]; GAP2 = s[4];
	createDots(dots1,s[1],ships1.length,0);
	createDots(dots2,s[2],ships2.length,1);
	var NBonly = parseInt(s[5]);
	if (NBonly) { stage.removeChild(bg); stage.addChildAt(bg2,0); }
	
	var HP1 = [];
	var HP2 = [];
	var s = phases[1].split('|');
	for (var i=0; i<s.length; i++) HP1.push(parseInt(s[i].split(',')[2]));
	var s = phases[2].split('|');
	for (var i=0; i<s.length; i++) HP2.push(parseInt(s[i].split(',')[2]));
	eventqueue.push([battleStart,[],{e:0,HP1:HP1.slice(),HP2:HP2.slice()}]);

	//set up events
	var f2 = fleet2;
	for (i=3; i<phases.length; i++) {
		var parts = phases[i].substring(2,phases[i].length).split('|');
		if (parts == '') continue;
		if (phases[i][0] == 'S' || phases[i][0] == 'N') {
			if (phases[i][0] == 'N' && !NBonly) { eventqueue.push([wait,[1000],null]); eventqueue.push([shutters,[],null]);}
			for (j=0; j<parts.length; j++) {
				var data = parts[j].split(','); data[0] = parseInt(data[0]); data[1] = parseInt(data[1]);
				var state = {e:eventqueue.length,HP1:HP1.slice(),HP2:HP2.slice()};
				if (data[1] < 10) HP1[data[1]] -= Math.max(0,parseInt(data[3])); //set up states
				else HP2[data[1]-10] -= Math.max(0,parseInt(data[3]));
				var ship = (data[0] < 10) ? fleet1[data[0]] : f2[data[0]-10];
				var target = (data[1] < 10) ? fleet1[data[1]] : f2[data[1]-10];
				if (data[2] == '1') eventqueue.push([shoot,[ship,target,parseInt(data[3])],state]);
				else if(data[2] == '2') eventqueue.push([shootDA,[ship,target,parseInt(data[3]),parseInt(data[4])],state]);
				else if(data[2] == '3') eventqueue.push([shootCutIn,[ship,target,parseInt(data[3])],state]);
				else if(data[2] == '4') eventqueue.push([shootPlane,[ship,target,parseInt(data[3])],state]);
				else if(data[2] == '5') eventqueue.push([shootASW,[ship,target,parseInt(data[3])],state]);
				else if(data[2] == '6') eventqueue.push([shootBigTorp,[ship,target,parseInt(data[3])],state]);
				else if(data[2] == '7') eventqueue.push([shootBigGun,[ship,target,parseInt(data[3])],state]);
				else if(data[2] == '8') eventqueue.push([shootTorp,[ship,target,parseInt(data[3])],state]);
			}
		} else if (phases[i][0] == 'T' || phases[i][0] == 'A') {
			var shots = []; var extra = [];
			if (phases[i][0] == 'A') {
				var s = phases[i].substring(2,phases[i].length).split(':');
				parts = s[1].split('|');
				extra = s[0].split(',');
				if (parts[0]=='') parts = [];
				for (var j=0; j<4; j++) if (j < extra.length) extra[j] = parseInt(extra[j]); else extra.push(0);
			}
			var state = {e:eventqueue.length,HP1:HP1.slice(),HP2:HP2.slice()};
			for (j=0; j<parts.length; j++) {
				var data = parts[j].split(','); data[0] = parseInt(data[0]); data[1] = parseInt(data[1]);
				if (data[1] < 10) HP1[data[1]] -= Math.max(0,parseInt(data[2])); //set up states
				else HP2[data[1]-10] -= Math.max(0,parseInt(data[2]));
				data[0] = (data[0] < 10) ? fleet1[data[0]] : f2[data[0]-10];
				data[1] = (data[1]==-1)? -1: (data[1] < 10) ? fleet1[data[1]] : f2[data[1]-10];
				for (var k=2; k<data.length; k++) data[k] = parseInt(data[k]);
				if (data.length > 3) data[3] = (data[3] < 10)? fleet1[data[3]] : f2[data[3]-10];
				shots.push(data);
			}
			if (shots.length > 0) {
				eventqueue.push([wait,[1000],null]);
				if (phases[i][0] == 'T') eventqueue.push([GTorpedoPhase,[shots],state]);
				else if(phases[i][0] == 'A') eventqueue.push([GAirPhase,[shots,extra[0],extra[1],extra[2],extra[3]],state]);
			}
		} else if (phases[i][0] == 'B') {
			var battledata = phases[i].substr(2).split(',');
			var newships = phases[i+2].split('|');
			for (var j=0; j<newships.length; j++) newships[j] = createShip(newships[j].split(','),1,j);
			eventqueue.push([wait,[3000]]);
			eventqueue.push([shuttersNextBattle,[battledata,newships]]);
			eventqueue.push([battleStart,[]]);
			f2 = newships;
			NBonly = (battledata[5]=='1');
			i+=2;
		}
	}
	eventqueue.push([battleEnd,[],{e:eventqueue.length,HP1:HP1.slice(),HP2:HP2.slice()}]);
	// console.log(eventqueue);
	// ecomplete = true;
	
	stage.addChild(shutterTop); stage.addChild(shutterBottom);
	shutterTop.y = -246; shutterTop.alpha = .25;
	shutterBottom.y = 456; shutterBottom.alpha = .25;
	
	animate();
}